<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="https://img.icons8.com/?size=100&id=Gyog0NkQyHUL&format=png&color=000000"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMTStation_SimpleCreationAssistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
            background: #56858A;
            min-height: 100vh;
            color: #132234;
            font-size: 12px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 8px;
        }

        .header {
            border: 2px outset #F7E0C3;
            background: #E5D0BB;
            text-align: center;
            margin-bottom: 8px;
            color: #132234;
            height: 30px;
        }

        .header h1 {
            font-size: 18px;
            margin-bottom: 4px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

       .header h2 {
            font-size: 11px;
            margin-top: 0dvh;
            padding-top: 2.6dvh;
            margin-right: 0.5dvh;
            margin-bottom: 100dvh;
            font-weight: normal;
            display: flex;
            justify-content: flex-end;
            flex-direction: row;
        }

        /* å…¨åŸŸç‹€æ…‹é¡¯ç¤ºå€åŸŸ */
        .global-status {
            margin-top: 20px;
            background: #FCEAD1;
            color: #1F3D5D;
            padding: 4px 8px;
            font-size: 11px;
            margin-bottom: 18px;
            border: 1px inset #FCEAD1;
            display: flex;
            justify-content: space-between;
        }

        /* é é¢å°è¦½å™¨æ¨£å¼ - æ”¹é€²éŸ¿æ‡‰å¼è¨­è¨ˆ */
        .navigation {
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 4px;
            min-height: 30px;
        }

        .nav-btn {
            background: #F7E0C3;
            color: #132234;
            border: 2px outset #F7E0C3;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: normal;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 80px;
            justify-content: center;
            flex: 0 0 auto;
        }

        .nav-btn:hover {
            background: #68AAB2;
            border-color: #68AAB2;
        }

        .nav-btn:active {
            border: 2px inset #F7E0C3;
        }

        .nav-btn.active {
            background: #1F3D5D;
            color: #F7E0C3;
            border: 2px inset #F7E0C3;
        }

        .nav-icon {
            width: 12px;
            height: 12px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .panel {
            margin-top: 8px;
            background: #F7E0C3;
            border: 2px outset #F7E0C3;
            padding: 8px;
            box-shadow: 2px 2px 1px #132234;
        }

        .panel h2 {
            color: #132234;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: bold;
            background: #1F3D5D;
            color: #F7E0C3;
            padding: 2px 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .panel-icon {
            width: 12px;
            height: 12px;
        }

        .template-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 4px;
            margin-bottom: 8px;
        }

        .template-btn {
            background: #F7E0C3;
            color: #132234;
            border: 2px outset #F7E0C3;
            padding: 4px 8px;
            font-size: 12px;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
            gap: 4px;
            margin-top: 4px;
            align-items: center;
            justify-content: center;
        }

        .template-btn:hover {
            background: #68AAB2;
            border-color: #68AAB2;
        }

        .template-btn:active {
            border: 2px inset #F7E0C3;
        }

        .quick-btn {
            background: #F7E0C3;
            color: #132234;
            border: 2px outset #F7E0C3;
            padding: 2px 6px;
            font-size: 12px;
            margin: 2px;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .quick-btn:hover {
            background: #68AAB2;
            border-color: #68AAB2;
        }

        .quick-btn:active {
            border: 2px inset #F7E0C3;
        }

        .input-group {
            margin-bottom: 8px;
        }

        .input-group label {
            display: block;
            margin-bottom: 2px;
            font-weight: normal;
            color: #132234;
            font-size: 12px;
        }

        input, textarea, select {
            width: 100%;
            padding: 2px;
            border: 2px inset #E5D0BB;
            background: #E5D0BB;
            color: #132234;
            font-size: 12px;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
        }

        input:focus, textarea:focus, select:focus {
            outline: 1px dotted #132234;
        }

        textarea {
            min-height: 60px;
            resize: vertical;
        }

        .output-area {
            grid-column: 1 / -1;
        }

        #output, #checkerOutput {
            background: #E5D0BB;
            color: #132234;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.2;
            min-height: 120px;
            padding: 4px;
            white-space: pre-wrap;
            overflow-y: auto;
            border: 2px inset #F7E0C3;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .action-btns {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            background: #F7E0C3;
            color: #132234;
            border: 2px outset #F7E0C3;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: normal;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn:hover, .toggle-btn:hover {
            background: #68AAB2;
            border-color: #68AAB2;
        }

        .action-btn:active {
            border: 2px inset #F7E0C3;
        }

        .world-book-panel {
            background: #F7E0C3;
            color: #F7E0C3;
            border: 2px outset #F7E0C3;
            box-shadow: 2px 2px 1px #132234;
        }

        .world-book-panel h3 {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .world-book-panel input {
            background: #E5D0BB;
            color: #132234;
        }

        .world-book-panel label {
            color: #132234;
        }

        .world-book-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-bottom: 8px;
        }

        .number-input {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .number-input button {
            width: 20px;
            height: 20px;
            border: 2px outset #F7E0C3;
            background: #F7E0C3;
            color: #132234;
            font-size: 12px;
            font-weight: bold;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
        }

        .number-input button:hover {
            background: #68AAB2;
            border-color: #68AAB2;
        }

        .number-input button:active {
            border: 2px inset #F7E0C3;
        }

        .number-input input {
            width: 40px;
            text-align: center;
        }

        .repeat-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }

        .btn-icon {
            width: 12px;
            height: 12px;
        }

        /* Windows 98 ç‰¹æœ‰æ•ˆæœ */
        .window-title {
            background: #1F3D5D;
            color: #F7E0C3;
            padding: 2px;
            font-size: 12px;
            font-weight: bold;
            margin: -8px -8px 8px -8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-bar {
            background: #FCEAD1;
            border: 1px inset #FCEAD1;
            padding: 2px 4px;
            font-size: 11px;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
        }

        /* æ–°å¢ï¼šé—œéµè©è¼¸å…¥æ¬„ä½çš„è¦–è¦ºåˆ†éš”ç¬¦è™Ÿ */
        .keyword-input {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .keyword-help {
            background: #E5D0BB !important;
            font-size: 11px;
            color: #132234;
            margin-top: 2px;
            line-height: 1.3;
        }

        /* å¡«å…¥ç¬¦è™Ÿå€åŸŸæ¨£å¼ */
        .symbol-section {
            border-top: 1px solid #E5D0BB;
            margin-top: 8px;
            padding-top: 8px;
        }

        .symbol-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .symbol-btn {
            background: #F7E0C3;
            color: #132234;
            border: 2px outset #F7E0C3;
            padding: 2px 6px;
            font-size: 12px;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            min-width: 60px;
            justify-content: center;
        }

        .symbol-btn:hover {
            background: #68AAB2;
            border-color: #68AAB2;
        }

        .symbol-btn:active {
            border: 2px inset #F7E0C3;
        }

        /* é é¢é¡¯ç¤ºæ§åˆ¶ */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* é¦–é ç‰¹æ®Šæ¨£å¼ */
        .home-info {
            background: rgba(246, 200, 184, 0.1);
            border-radius: 2px;
            padding: 8px;
            line-height: 1.4;
        }

        .home-info ul {
            margin-left: 16px;
            margin-top: 4px;
        }

        .home-info li {
            margin-bottom: 4px;
        }

        /* æ–‡æœ¬æª¢æŸ¥å™¨æ¨£å¼ */
        .toggle-btn {
            background: #F7E0C3;
            color: #132234;
            border: 2px outset #F7E0C3;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: normal;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
            gap: 4px;
            margin-top: 4px;
            align-items: center;
            justify-content: center;
        }

        .toggle-btn.active {
            background: #68AAB2;
            border: 2px inset #F7E0C3;
        }

        .preview-panel {
            width: 100%;
            padding: 2px;
            border: 2px inset #E5D0BB;
            background: #E5D0BB;
            color: #132234;
            font-size: 12px;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
            min-height: 60px;
            resize: vertical;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            display: none;
        }

        .preview-panel.active {
            display: block;
        }

        #previewContent {
        width: 100%;
        padding: 2px;
        border: 2px inset #E5D0BB;
        background: #E5D0BB;
        color: #132234;
        font-size: 12px;
        font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
         min-height: 60px;
        resize: vertical;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
        outline: none;
        cursor: text;
        }

        #previewContent:focus {
            outline: 1px dotted #132234;
        }

        /* å³æ™‚é è¦½é«˜äº®æ¨£å¼ */
        .highlight-whitespace {
            background-color: #d6c4b8;
            color: white;
            padding: 2px 4px;
            font-weight: bold;
        }

        .highlight-colon {
            background-color: #64caa0;
            color: white;
            padding: 2px 4px;
            font-weight: bold;
        }

        .highlight-user {
            background-color: #5786b8;
            color: white;
            padding: 2px 4px;
            font-weight: bold;
        }

        .highlight-char {
            background-color: #c5577c;
            color: white;
            padding: 2px 4px;
            font-weight: bold;
        }

        .legend {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
        }

        /* Tokenè¨ˆæ•¸å™¨æ¨£å¼ */
        .token-container {
            position: relative;
        }

        .token-counter {
            position: absolute;
            top: -20px;
            right: 0;
            background: #1F3D5D;
            color: #F7E0C3;
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 2px;
            font-weight: bold;
        }

        .token-input {
            min-height: 120px;
            font-family: 'Courier New', monospace;
        }

        /* æ–°å¢ï¼šæ–‡æœ¬æ›¿æ›å™¨ç›¸é—œæ¨£å¼ */
        .char-replace-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .btn-success {
            background: #F7E0C3;
            color: #132234;
            border: 2px outset #F7E0C3;
            padding: 4px 8px;
            font-size: 12px;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
            gap: 4px;
            margin-top: 4px;
            align-items: center;
            justify-content: center;
        }

        .btn-success:hover {
            background: #68AAB2;
            border-color: #68AAB2;
        }

        .btn-success:active {
            border: 2px inset #F7E0C3;
        }

        .btn-secondary {
            background: #F7E0C3;
            color: #132234;
            border: 2px outset #F7E0C3;
            padding: 4px 8px;
            font-size: 12px;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
            gap: 4px;
            margin-top: 4px;
            align-items: center;
            justify-content: center;
        }

        .btn-secondary:hover {
            background: #68AAB2;
            border-color: #68AAB2;
        }

        .btn-secondary:active {
            border: 2px inset #F7E0C3;
        }

        .btn-primary {
            background: #F7E0C3;
            color: #132234;
            border: 2px outset #F7E0C3;
            padding: 4px 8px;
            font-size: 12px;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
            gap: 4px;
            margin-top: 4px;
            align-items: center;
            justify-content: center;
        }

        .btn-primary:hover {
            background: #68AAB2;
            border-color: #68AAB2;
        }

        .btn-primary:active {
            border: 2px inset #F7E0C3;
        }

        .input-textarea {
            min-height: 100px;
            font-family: 'MS Sans Serif', 'Microsoft Sans Serif', sans-serif;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                ğŸš‚RMT Stationâ–ªï¸Simple Creation Assistant
            </h1>
            <h2>
                ğŸš‚RMT è»Šç«™â–ªï¸ç°¡æ˜“å‰µä½œåŠ©æ‰‹_v1.2 20250912
            </h2>
        </div>
        <!-- å…¨åŸŸç‹€æ…‹é¡¯ç¤ºå€åŸŸ -->
        <div class="global-status" id="globalStatus">
                ç•¶å‰é é¢ï¼šé¦–é 
        </div>


        <!-- é é¢å°è¦½å™¨ -->
        <div class="navigation">
            <button class="nav-btn active" onclick="navigateToPage('home')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9,22 9,12 15,12 15,22"/>
                </svg>
                é¦–é 
            </button>
            <button class="nav-btn" onclick="navigateToPage('worldbook')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                ä¸–ç•Œæ›¸è§¸ç™¼æ¨¡æ¿
            </button>
            <button class="nav-btn" onclick="navigateToPage('textreplace')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                </svg>
                æŒ‡ä»¤æ”¹å’’å™¨
            </button>
            <button class="nav-btn" onclick="navigateToPage('checker')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 12l2 2 4-4"/>
                    <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"/>
                    <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"/>
                    <path d="M12 3c0 1-1 3-3 3s-3-2-3-3 1-3 3-3 3 2 3 3"/>
                    <path d="M12 21c0-1-1-3-3-3s-3 2-3 3 1 3 3 3 3-2 3-3"/>
                </svg>
                æ–‡æœ¬æª¢æŸ¥å™¨
            </button>
            <button class="nav-btn" onclick="navigateToPage('token')">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
                    <path d="M9 12l2 2 4-4"/>
                </svg>
                Tokenè¨ˆæ•¸å™¨
            </button>
        </div>

        <!-- é¦–é  -->
        <div id="home-page" class="page active">
            <div class="panel">
                <div class="window-title">
                    <svg class="panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    æ­¡è¿ä½¿ç”¨ RMTè»Šç«™çš„ç°¡æ˜“å‰µä½œåŠ©æ‰‹
                </div>
                <div class="home-info">
                    <strong>â–¼ åŠŸèƒ½ä»‹ç´¹ï¼š</strong><br>
                    <ul>
                        <li>ä¸–ç•Œæ›¸è§¸ç™¼æ¨¡æ¿ï¼šæä¾›å¿«é€Ÿç”ŸæˆRegexè§¸ç™¼çš„é—œéµå­—</li>
                        <li>æŒ‡ä»¤æ”¹å’’å™¨ï¼šå¿«é€Ÿç·¨è¼¯è¼¸å…¥çš„æ–‡æœ¬ï¼Œæ–¹ä¾¿ä¿®æ”¹OOCæŒ‡ä»¤èˆ‡å’’èª</li>
                        <li>æ–‡æœ¬æª¢æŸ¥å™¨ï¼šæª¢æŸ¥è¼¸å…¥çš„å„ç¨®è¦ç´ ï¼Œé™„å¸¶å³æ™‚é è¦½æ¨¡å¼ï¼Œå¯åŒæ™‚ä¿®æ”¹æª¢æŸ¥æ–‡æœ¬</li>
                        <li>Tokenè¨ˆæ•¸å™¨ï¼šå³æ™‚è¨ˆç®—è¼¸å…¥æ–‡æœ¬çš„Tokenså­—ç¬¦ï¼Œåƒ…ä¾›åƒè€ƒ</li>
                    <br>
                    </ul>
                    <strong>âœ ä½¿ç”¨èªªæ˜ï¼š</strong><br>
                    <ul>
                    <li>é»æ“Šä¸Šæ–¹å°è¦½æŒ‰éˆ•åˆ‡æ›ä¸åŒåŠŸèƒ½é é¢</li>
                    <li>ç”Ÿæˆçš„å…§å®¹éƒ½å¯ä»¥è¤‡è£½åˆ°å‰ªè²¼ç°¿æˆ–å„²å­˜ç‚ºæ–‡ä»¶</li>
                    </ul>
                    <br>
                    <strong>âš‘ æ›´æ–°æ­·ç¨‹ï¼š</strong><br>
                    <ul>
                    <li>2025/09/12_è¼¸å‡ºå€çµ±ä¸€æ ¼å¼ï¼Œéƒ¨åˆ†æ–°å¢å„²å­˜ç‚ºæª”æ¡ˆåŠŸèƒ½</li>
                    <li>2025/09/11_æ–°å¢æŒ‡ä»¤æ”¹å’’å™¨</li>
                    <li>2025/08/23_æ–‡æœ¬æª¢æŸ¥å™¨ï¼Œæ–°å¢æ‡‰ç”¨é«˜äº®é–‹é—œæŒ‰éˆ•</li>
                    <li>2025/08/20_Gitç¶²ç«™æ­£å¼å•Ÿç”¨</li>
                    <li>2025/08/20_æ–°å¢æ›´å¤šè§¸ç™¼æ¨¡æ¿ï¼Œcssæœ€çµ‚èª¿æ•´</li>
                    <li>2025/08/19_èª¿æ•´åˆ†è©å™¨ï¼Œæ›´è¶¨è¿‘çœŸå¯¦</li>
                    <li>2025/08/18_v1åˆç‰ˆå®Œæˆ</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ä¸–ç•Œæ›¸è§¸ç™¼æ¨¡æ¿é é¢ -->
        <div id="worldbook-page" class="page">
            <div class="panel world-book-panel">
                <div class="window-title">
                    <svg class="panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                    è¨­ç½®Regexè§¸ç™¼ (é—œéµè© Key)
                </div>
                <div class="keyword-help" style="margin-bottom: 8px; padding: 4px; background: rgba(246, 200, 184, 0.1); border-radius: 2px;">
                    <strong>é—œéµè©è¼¸å…¥èªªæ˜ï¼š</strong><br>
                    â€¢ ä½¿ç”¨ <code>|</code> åˆ†éš”å¤šå€‹é¸é …ï¼ˆå¦‚ï¼šæˆ‘|å¦³|ä»–ï¼‰<br>
                    â€¢ ä½¿ç”¨ <code>, </code> è¼¸å…¥æœƒè‡ªå‹•è½‰æ›ç‚º <code>|</code>ï¼ˆå¦‚ï¼šæˆ‘, å¦³ â†’ æˆ‘|å¦³ï¼‰<br>
                    â€¢ ç©ºç™½çš„ <code>|</code> å€æ®µå°‡è‡ªå‹•ç§»é™¤
                </div>
                <div class="world-book-controls">
                    <div class="input-group">
                        <label>ä¸­é–“(?:text)æ®µæ•¸é‡:</label>
                        <div class="number-input">
                            <button onclick="changeWorldBookCount(-1)">-</button>
                            <input type="number" id="worldBookCount" value="1" min="0">
                            <button onclick="changeWorldBookCount(1)">+</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <button class="template-btn" onclick="setupWorldBookInputs()">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 20h9"/>
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                            </svg>
                            è¨­å®šé—œéµè©
                        </button>
    <button class="template-btn" onclick="generateWorldBook()" style="margin-top: 4px;">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9,11 12,14 22,4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
        </svg>
        ç”Ÿæˆé€£æ¥å‹æ¨¡æ¿
    </button>
    <button class="template-btn" onclick="generateWorldBook2()" style="margin-top: 4px;">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9,11 12,14 22,4"/>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
        </svg>
        ç”Ÿæˆæ™®é€šå‹æ¨¡æ¿
    </button>
                    </div>
                </div>

                <!-- å¡«å…¥ç¬¦è™Ÿå€åŸŸ -->
                <div class="symbol-section">
                    <label style="color: #132234; font-weight: bold; margin-bottom: 4px; display: block;">å¡«å…¥ç¬¦è™Ÿ:</label>
                    <div class="symbol-buttons">
                        <button class="symbol-btn" onclick="insertSymbol('separator')">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            åˆ†éš”ç·š
                        </button>
                        <button class="symbol-btn" onclick="insertSymbol('bracket1')">

                            [
                        </button>
                        <button class="symbol-btn" onclick="insertSymbol('bracket2')">
                            ]
                        </button>
                        <button class="symbol-btn" onclick="insertSymbol('hash')">
                            ###
                        </button>
                    </div>
                </div>

                <div id="worldBookInputs" class="world-book-controls" style="display: none; margin-top: 8px; border-top: 1px solid #F7E0C3; padding-top: 8px;">
                    <!-- å‹•æ…‹ç”Ÿæˆçš„è¼¸å…¥æ¡†æœƒå‡ºç¾åœ¨é€™è£¡ -->
                </div>
            </div>

            <div class="panel output-area">
                <div class="window-title">
                    <svg class="panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 5H7a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h2m0-18h2.5a2.5 2.5 0 0 1 0 5H11h.5a2.5 2.5 0 0 1 0 5H11"/>
                        <path d="M5 5l14 14"/>
                        <path d="m19 5-14 14"/>
                    </svg>
                    è¼¸å‡ºçµæœ
                </div>
                <div id="output">é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¾†ç”Ÿæˆæ¨¡æ¿...</div>
                <div class="action-btns">
                    <button class="action-btn" onclick="copyToClipboard()">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        è¤‡è£½
                    </button>
                    <button class="action-btn" onclick="clearOutput()">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3,6 5,6 21,6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        æ¸…ç©º
                    </button>
                    <button class="action-btn" onclick="saveAsFile()">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17,21 17,13 7,13 7,21"/>
                            <polyline points="7,3 7,8 15,8"/>
                        </svg>
                        å„²å­˜ç‚ºæª”æ¡ˆ
                    </button>
                </div>
                <div class="status-bar">
                    <span>å°±ç·’</span>
                    <span id="statusText">ç­‰å¾…æ“ä½œ</span>
                </div>
            </div>
        </div>

<!-- æ–‡æœ¬æª¢æŸ¥å™¨é é¢ -->
    <div id="checker-page" class="page">
        <div class="panel">
            <div class="window-title">
                <svg class="panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 12l2 2 4-4"/>
                    <circle cx="12" cy="12" r="9"/>
                </svg>
                æ–‡æœ¬æª¢æŸ¥å™¨
            </div>
            <div class="input-group">
                <label>è¼¸å…¥è¦æª¢æŸ¥çš„æ–‡æœ¬:</label>
                <textarea id="checkerInput" class="checker-input" placeholder="è«‹è¼¸å…¥è¦æª¢æŸ¥çš„æ–‡æœ¬å…§å®¹..."></textarea>
            </div>
            <div class="checker-buttons">
                <button class="toggle-btn" id="previewToggle" onclick="togglePreview()">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    å³æ™‚é è¦½
                </button>
                <button class="toggle-btn" id="highlightToggle" onclick="toggleHighlight()" style="display: none;">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <circle cx="9" cy="9" r="2"/>
                        <path d="m21 15-3.086-3.086a2 2 0 0 0-1.414-.586H15"/>
                        <path d="M7 13h10"/>
                    </svg>
                    æ‡‰ç”¨é«˜äº®
                </button> 
                <button class="template-btn" onclick="checkLength()">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <polyline points="7.5,10.5 12,15 16.5,10.5"/>
                    </svg>
                    æª¢æŸ¥é•·åº¦
                </button>
                <button class="template-btn" onclick="checkSpaces()">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6"/>
                        <path d="m21 12-6 0m-6 0-6 0"/>
                    </svg>
                    ç©ºç™½å­—ç¬¦
                </button>
            </div>
        </div>

        <div class="panel output-area">
            <div class="window-title">
                <svg class="panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14,2 14,8 20,8"/>
                </svg>
                æª¢æŸ¥çµæœ
            </div>
            
            <!-- å‚³çµ±æª¢æŸ¥çµæœ -->
            <div id="checkerOutput">è«‹è¼¸å…¥æ–‡æœ¬ä¸¦é¸æ“‡æª¢æŸ¥é …ç›®...</div>
            
            <!-- å³æ™‚é è¦½é¢æ¿ -->
            <div id="previewPanel" class="preview-panel">
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #64caa0;"></div>
                        <span>å†’è™Ÿ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #d6c4b8;"></div>
                        <span>ç©ºæ ¼</span>
                        </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #5786b8;"></div>
                        <span>user</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #c5577c;"></div>
                        <span>char</span>
                    </div>
                </div>
                <div id="previewContent" contenteditable="true">è«‹è¼¸å…¥æ–‡æœ¬ä»¥æŸ¥çœ‹å³æ™‚é è¦½...</div>
            </div>
            
            <div class="action-btns">
                <button class="action-btn" onclick="copyCheckerResult()">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    è¤‡è£½
                </button>
                <button class="action-btn" onclick="clearCheckerOutput()">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3,6 5,6 21,6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    æ¸…ç©º
                </button>
                <button class="action-btn" onclick="saveCheckerFile()">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17,21 17,13 7,13 7,21"/>
                    <polyline points="7,3 7,8 15,8"/>
                    </svg>
                    å„²å­˜ç‚ºæª”æ¡ˆ
                </button>
            </div>
            <div class="status-bar">
                <span>å°±ç·’</span>
                <span id="checkerStatusText">ç­‰å¾…æ“ä½œ</span>
            </div>
        </div>
    </div>

    
        <!-- Tokenè¨ˆæ•¸å™¨é é¢ -->
        <div id="token-page" class="page">
            <div class="panel">
                <div class="window-title">
                    <svg class="panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7v10c0 5.55 3.84 9.74 9 11 5.16-1.26 9-5.45 9-11V7l-10-5z"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                    Tokenè¨ˆæ•¸å™¨
                </div>
                <div class="input-group">
                    <label>è¼¸å…¥è¦è¨ˆç®—Tokençš„æ–‡æœ¬:</label>
                    <div class="token-container">
                        <div class="token-counter" id="tokenCounter">Tokens: 0</div>
                        <textarea id="tokenInput" class="token-input" placeholder="è«‹è¼¸å…¥è¦è¨ˆç®—Tokenæ•¸é‡çš„æ–‡æœ¬..." oninput="calculateTokens()"></textarea>
                    </div>
                </div>
                <div class="keyword-help" style="margin-top: 8px; padding: 4px; background: rgba(246, 200, 184, 0.1); border-radius: 2px;">
                    <strong>Tokenè¨ˆç®—èªªæ˜ï¼š</strong><br>
                    â€¢ Tokenè¨ˆç®—åŸºæ–¼å­—ç¬¦æ•¸çš„ç°¡ç´„ä¼°ç®—å…¬å¼<br>
                    â€¢ å¯¦éš›Tokenæ•¸å¯èƒ½å› æ¨¡å‹è€Œç•°ï¼Œåƒ…ä¾›åƒè€ƒ<br>
                    â€¢ å¯¦ç”¨Tokenizerç¶²ç«™æ¨è–¦:Open.AI
                </div>
            </div>
        </div>

        <!-- æŒ‡ä»¤æ”¹å’’å™¨é é¢ -->
         <div id="textreplace-page" class="page">
            
            <!-- è¼¸å…¥å€åŸŸ -->
            <div class="panel">
                <div class="window-title">
                    <svg class="panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                    </svg>
                    è¼¸å…¥æ–‡æœ¬
                </div>

                <div class="keyword-help" style="margin-top: 8px; padding: 4px; background: rgba(246, 200, 184, 0.1); border-radius: 2px;">
                    <strong>åŠŸèƒ½èªªæ˜ï¼š</strong><br>
                    â€¢ {{char}} â†” {{user}} äº¤æ›ï¼šå°‡æ–‡æœ¬ä¸­çš„ {{char}} å’Œ {{user}} äº’ç›¸æ›¿æ›<br>
                    â€¢ æ’å…¥é è¨­æŒ‡ä»¤ï¼šåœ¨æ–‡æœ¬é–‹é ­æ’å…¥é è¨­çš„ OOC æŒ‡ä»¤<br>
                </div>

                <div class="input-section">
                    <label class="input-label">è«‹è¼¸å…¥è¦è™•ç†çš„æ–‡æœ¬ï¼š</label>
                    <textarea 
                        id="inputText" 
                        class="input-textarea" 
                        placeholder="åœ¨æ­¤è¼¸å…¥åŒ…å« {{char}} å’Œ {{user}} çš„æ–‡æœ¬..."
                    ></textarea>
                </div>
                <select id="oocSelect">
                    <option value="option1">[OOC: è«‹ç«‹åˆ»æš«åœåŠ‡æƒ…ï¼Œä¸¦é–‹å§‹æ¼”ç¹¹ä¸€æ®µæ–°åŠ‡æƒ…å’Œæƒ…å¢ƒ]</option>
                    <option value="option2">[OOC: è«‹é–‹å§‹æ¼”ç¹¹ä»¥ä¸‹åŠ‡æƒ…: </option>
                    <option value="option3">{{char}}æœƒæœ‰ä»€éº¼åæ‡‰ï¼Ÿ{{char}}å…§å¿ƒæœƒç”¢ç”Ÿä»€éº¼æƒ³æ³•ï¼Ÿï¼Œ{{char}}åˆæœƒåšå‡ºä»€éº¼è¡Œå‹•ï¼Ÿ]</option>
                    <option value="option4">{{user}}æœƒæœ‰ä»€éº¼åæ‡‰ï¼Ÿ{{user}}å…§å¿ƒæœƒç”¢ç”Ÿä»€éº¼æƒ³æ³•ï¼Ÿï¼Œ{{user}}åˆæœƒåšå‡ºä»€éº¼è¡Œå‹•ï¼Ÿ]</option>
                    <option value="option5">[OOC: è«‹åƒè€ƒ{{char}}å’Œ{{user}}çš„è¨­å®šèˆ‡è£œå……è³‡è¨Šï¼Œä»¥ç”Ÿå‹•è©³ç´°çš„åŠ‡æƒ…æ–¹å¼æå¯«æ•´å€‹éç¨‹]</option>
                </select>
                <div class="controls-row">
                    <button class="btn btn-primary" onclick="swapCharUser()">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="17,1 21,5 17,9"/>
                            <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                            <polyline points="7,23 3,19 7,15"/>
                            <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                        </svg>
                        {{char}} â†” {{user}} äº¤æ›
                    </button>

                    <button class="btn btn-secondary" onclick="insertOOC()">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                        </svg>
                        æŒ‰æ­¤ç¢ºèªæ’å…¥
                    </button>

                    <button class="btn btn-secondary" onclick="insertEndBracket()">
                    ]
                    </button>
                </div>
            </div>

            <!-- è¼¸å‡ºå€åŸŸ -->
             
            <div class="panel">
                <div class="window-title">
                    <svg class="panel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>
                    è¼¸å‡ºçµæœ
                </div>

                <div class="input-section">
                    <textarea 
                        id="outputEditText" 
                        class="input-textarea output-textarea" 
                        readonly
                        placeholder="è™•ç†çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡..."
                    ></textarea>
                </div>

                <div class="action-btns">
                    <button class="btn btn-success" onclick="copyText()">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        è¤‡è£½
                    </button>
                    <button class="btn btn-primary" onclick="copyBackToInput()">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="17,1 21,5 17,9"/>
                            <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                        </svg>
                        åå‘è¤‡è£½
                    </button>
                    <button class="btn btn-success" onclick="clearAll()">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3,6 5,6 21,6"/>
                            <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"/>
                        </svg>
                        æ¸…ç©º
                    </button>
                    <button class="action-btn" onclick="saveTextEditFile()">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17,21 17,13 7,13 7,21"/>
                            <polyline points="7,3 7,8 15,8"/>
                        </svg>
                        å„²å­˜ç‚ºæª”æ¡ˆ
                    </button>
                </div>
                    <div class="status-bar">
                    <span>å°±ç·’</span>
                    <span id="editStatusStatusText">ç­‰å¾…æ“ä½œ</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 'home';

        // æ›´æ–°å…¨åŸŸç‹€æ…‹é¡¯ç¤ºçš„å‡½æ•¸
        function updateGlobalStatus(pageName) {
            const globalStatus = document.getElementById('globalStatus');
            if (globalStatus) {
                globalStatus.textContent = `ç•¶å‰é é¢ï¼š${pageName}`;
            }
        }

        function updateStatus(text) {
            const statusElement = document.getElementById('statusText');
            if (statusElement) {
                statusElement.textContent = text;
            }
        }

        // æ–°å¢ï¼šæ›´æ–°æª¢æŸ¥å™¨ç‹€æ…‹çš„å‡½æ•¸
        function updateCheckerStatus(text) {
            const statusElement = document.getElementById('checkerStatusText');
            if (statusElement) {
                statusElement.textContent = text;
            }
        }

        // æ–°å¢ï¼šæ›´æ–°ç·¨è¼¯å™¨ç‹€æ…‹çš„å‡½æ•¸
        function updateTextEditStatus(text) {
            const statusElement = document.getElementById('editStatusStatusText');
            if (statusElement) {
                statusElement.textContent = text;
            }
        }

        // é é¢å°è¦½åŠŸèƒ½ - ä¿®å¾©å¾Œçš„ç‰ˆæœ¬
        function navigateToPage(page) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰activeé¡åˆ¥
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ç‚ºç•¶å‰é é¢æŒ‰éˆ•æ·»åŠ  activeé¡åˆ¥
            event.target.closest('.nav-btn').classList.add('active');
            
            // é¡¯ç¤ºå°æ‡‰é é¢
            const targetPage = document.getElementById(page + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = page;
            }
            
            // æ›´æ–°é é¢ç‹€æ…‹é¡¯ç¤º
            const pageNames = {
                'home': 'é¦–é ',
                'worldbook': 'ä¸–ç•Œæ›¸è§¸ç™¼æ¨¡æ¿',
                'checker': 'æ–‡æœ¬æª¢æŸ¥å™¨',
                'token': 'Tokenè¨ˆæ•¸å™¨',
                'textreplace': 'æŒ‡ä»¤æ”¹å’’å™¨'
            };
            
            const pageName = pageNames[page] || 'æœªçŸ¥é é¢';
            updateGlobalStatus(pageName);
        }

        // å¡«å…¥ç¬¦è™ŸåŠŸèƒ½
        function insertSymbol(type) {
            let value;
            
            switch (type) {
                case 'separator':
                    value = '='.repeat(50);
                    break;
                case 'bracket1':
                    value = '[';
                    break;
                case 'bracket2':
                    value = ']';
                    break;
                case 'hash':
                    value = '###';
                    break;
            }

            const output = document.getElementById('output');
            if (output.textContent.includes('é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¾†ç”Ÿæˆæ¨¡æ¿...')) {
                output.textContent = value;
            } else {
                output.textContent += (output.textContent.trim() ? '\n' : '') + value;
            }
            
            updateStatus(`å·²æ’å…¥${getSymbolName(type)}`);
        }

        function getSymbolName(type) {
            const names = {
                'separator': 'åˆ†éš”ç·š',
                'bracket1': 'ä¸Šæ–¹æ‹¬è™Ÿ',
                'bracket2': 'ä¸‹æ–¹æ‹¬è™Ÿ',
                'hash': 'äº•è™Ÿ'
            };
            return names[type] || 'ç¬¦è™Ÿ';
        }

// æ–°å¢ï¼šè™•ç†é—œéµè©çš„å‡½æ•¸
function processKeywords(inputValue) {
    if (!inputValue.trim()) return '';
    
    // å…ˆå°‡ ', ' æ›¿æ›ç‚º '|'
    let processed = inputValue.replace(/,\s+/g, '|');
    
    // ç§»é™¤ç©ºçš„æ®µè½ï¼ˆé€£çºŒçš„ | æˆ–é–‹é ­çµå°¾çš„ |ï¼‰
    processed = processed
        .split('|')
        .filter(segment => segment.trim() !== '')
        .join('|');
    
    return processed;
}

function setupWorldBookInputs() {
    const count = parseInt(document.getElementById('worldBookCount').value) || 0;
    const inputsContainer = document.getElementById('worldBookInputs');
    
    // æ¸…ç©ºç¾æœ‰è¼¸å…¥æ¡†
    inputsContainer.innerHTML = '';
    
    // ç¸½æ˜¯æœ‰é–‹é ­è¼¸å…¥æ¡†
    const startInputGroup = document.createElement('div');
    startInputGroup.className = 'input-group';
    startInputGroup.innerHTML = `
        <label for="worldBookStart">é–‹é ­é—œéµè©:</label>
        <input type="text" id="worldBookStart" class="keyword-input" placeholder="è¼¸å…¥é–‹é ­é—œéµè©ï¼ˆæ”¯æ´ | æˆ– , åˆ†éš”å¤šé¸é …ï¼‰">
        <div class="keyword-help">ç¯„ä¾‹ï¼šæˆ‘|ä½ |ä»–|{{user}}|{{char}} æˆ– æˆ‘, ä½ , ä»–, {{user}}, {{char}}</div>
    `;
    inputsContainer.appendChild(startInputGroup);
    
    // ç”Ÿæˆä¸­é–“æ®µè¼¸å…¥æ¡†
    for (let i = 1; i <= count; i++) {
        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group';
        inputGroup.innerHTML = `
            <label for="worldBookMiddle${i}">ä¸­é–“é—œéµè© ${i}:</label>
            <input type="text" id="worldBookMiddle${i}" class="keyword-input" placeholder="è¼¸å…¥ç¬¬${i}å€‹ä¸­é–“é—œéµè©ï¼ˆæ”¯æ´ | æˆ– , åˆ†éš”å¤šé¸é …ï¼‰">
            <div class="keyword-help">ç¯„ä¾‹ï¼šè·‘å‘|æ„›|çœ‹åˆ°|çš„|åœ° æˆ– è·‘å‘, æ„›, çœ‹åˆ°, çš„, åœ°</div>
        `;
        inputsContainer.appendChild(inputGroup);
    }
    
    // ç¸½æ˜¯æœ‰çµå°¾è¼¸å…¥æ¡†
    const endInputGroup = document.createElement('div');
    endInputGroup.className = 'input-group';
    endInputGroup.innerHTML = `
        <label for="worldBookEnd">çµå°¾é—œéµè©:</label>
        <input type="text" id="worldBookEnd" class="keyword-input" placeholder="è¼¸å…¥çµå°¾é—œéµè©ï¼ˆæ”¯æ´ | æˆ– , åˆ†éš”å¤šé¸é …ï¼‰">
        <div class="keyword-help">ç¯„ä¾‹ï¼šä»–|{{char}}|å—|å‘¢|é‚£è£¡ æˆ– ä»–, {{char}}, å—, å‘¢, é‚£è£¡</div>
    `;
    inputsContainer.appendChild(endInputGroup);
    
    inputsContainer.style.display = 'grid';
    updateStatus('å·²è¨­å®šé—œéµè©è¼¸å…¥æ¡†');
}

function generateWorldBook() {
    const count = parseInt(document.getElementById('worldBookCount').value) || 0;
    
    // æª¢æŸ¥æ˜¯å¦å·²è¨­å®šè¼¸å…¥æ¡†
    const inputsContainer = document.getElementById('worldBookInputs');
    if (inputsContainer.style.display === 'none' || inputsContainer.children.length === 0) {
        alert('è«‹å…ˆé»æ“Šã€Œè¨­å®šé—œéµè©ã€æŒ‰éˆ•');
        return;
    }
    
    // å–å¾—é–‹é ­å’Œçµå°¾é—œéµè©
    const startInput = document.getElementById('worldBookStart');
    const endInput = document.getElementById('worldBookEnd');
    
    const startKeyword = startInput ? processKeywords(startInput.value) : '';
    const endKeyword = endInput ? processKeywords(endInput.value) : '';
    
    if (!startKeyword) {
        alert('è«‹å¡«å…¥é–‹é ­é—œéµè©');
        return;
    }
    if (!endKeyword) {
        alert('è«‹å¡«å…¥çµå°¾é—œéµè©');
        return;
    }
    
    // æ”¶é›†ä¸­é–“é—œéµè©
    const middleKeywords = [];
    for (let i = 1; i <= count; i++) {
        const input = document.getElementById(`worldBookMiddle${i}`);
        const processedValue = input ? processKeywords(input.value) : '';
        if (!processedValue) {
            alert(`è«‹å¡«å…¥ä¸­é–“é—œéµè© ${i}`);
            return;
        }
        middleKeywords.push(processedValue);
    }

    // ç”Ÿæˆé€£æ¥å‹æ¨¡æ¿
    let newTemplate = `# ä¸–ç•Œæ›¸(Regexè§¸ç™¼)
## é—œéµè©/Key(é€£æ¥å‹)
/(?:${startKeyword})`;

    // æ·»åŠ ä¸­é–“çš„.*?(?:keyword)æ®µ
    for (let i = 0; i < middleKeywords.length; i++) {
        newTemplate += `.*?(?:${middleKeywords[i]})`;
    }
    
    // æ·»åŠ çµå°¾
    newTemplate += `.*?(?:${endKeyword})/i`;
    
    // ç²å–ç¾æœ‰å…§å®¹ä¸¦è¿½åŠ æ–°æ¨¡æ¿
    const outputElement = document.getElementById('output');
    if (outputElement.textContent.includes('é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¾†ç”Ÿæˆæ¨¡æ¿...')) {
        outputElement.textContent = newTemplate;
    } else {
        outputElement.textContent += (outputElement.textContent.trim() ? '\n' : '') + newTemplate;
    }
    
    updateStatus('é€£æ¥å‹æ¨¡æ¿å·²ç”Ÿæˆ');
}


function generateWorldBook2() {
    const count = parseInt(document.getElementById('worldBookCount').value) || 0;
    
    // æª¢æŸ¥æ˜¯å¦å·²è¨­å®šè¼¸å…¥æ¡†
    const inputsContainer = document.getElementById('worldBookInputs');
    if (inputsContainer.style.display === 'none' || inputsContainer.children.length === 0) {
        alert('è«‹å…ˆé»æ“Šã€Œè¨­å®šé—œéµè©ã€æŒ‰éˆ•');
        return;
    }
    
    // å–å¾—é–‹é ­å’Œçµå°¾é—œéµè©
    const startInput = document.getElementById('worldBookStart');
    const endInput = document.getElementById('worldBookEnd');
    
    const startKeyword = startInput ? processKeywords(startInput.value) : '';
    const endKeyword = endInput ? processKeywords(endInput.value) : '';
    
    if (!startKeyword) {
        alert('è«‹å¡«å…¥é–‹é ­é—œéµè©');
        return;
    }
    if (!endKeyword) {
        alert('è«‹å¡«å…¥çµå°¾é—œéµè©');
        return;
    }
    
    // æ”¶é›†ä¸­é–“é—œéµè©
    const middleKeywords = [];
    for (let i = 1; i <= count; i++) {
        const input = document.getElementById(`worldBookMiddle${i}`);
        const processedValue = input ? processKeywords(input.value) : '';
        if (!processedValue) {
            alert(`è«‹å¡«å…¥ä¸­é–“é—œéµè© ${i}`);
            return;
        }
        middleKeywords.push(processedValue);
    }

    // ç”Ÿæˆæ™®é€šå‹æ¨¡æ¿ï¼ˆä¸ä½¿ç”¨.*?é€£æ¥ï¼‰
    let newTemplate = `# ä¸–ç•Œæ›¸(Regexè§¸ç™¼)
## é—œéµè©/Key(æ™®é€šå‹)
/(?:${startKeyword})`;

    // ç›´æ¥é€£æ¥ä¸­é–“é—œéµè©ï¼Œä¸ä½¿ç”¨.*?
    for (let i = 0; i < middleKeywords.length; i++) {
        newTemplate += `(?:${middleKeywords[i]})`;
    }
    
    // æ·»åŠ çµå°¾
    newTemplate += `(?:${endKeyword})/i`;
    
    // ç²å–ç¾æœ‰å…§å®¹ä¸¦è¿½åŠ æ–°æ¨¡æ¿
    const outputElement = document.getElementById('output');
    if (outputElement.textContent.includes('é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¾†ç”Ÿæˆæ¨¡æ¿...')) {
        outputElement.textContent = newTemplate;
    } else {
        outputElement.textContent += (outputElement.textContent.trim() ? '\n' : '') + newTemplate;
    }
    
    updateStatus('æ™®é€šå‹æ¨¡æ¿å·²ç”Ÿæˆ');
}

function changeWorldBookCount(delta) {
    const input = document.getElementById('worldBookCount');
    const current = parseInt(input.value) || 1;
    const newValue = Math.max(0, current + delta);
    input.value = newValue;
    
    // å¦‚æœè¼¸å…¥æ¡†å·²ç¶“é¡¯ç¤ºï¼Œè‡ªå‹•æ›´æ–°
    const inputsContainer = document.getElementById('worldBookInputs');
    if (inputsContainer.style.display !== 'none') {
        setupWorldBookInputs();
    }
    updateStatus(`ä¸­é–“æ®µæ•¸é‡: ${newValue}`);
}

        function copyToClipboard() {
            const output = document.getElementById('output').textContent;
            if (!output.trim() || output.includes('é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¾†ç”Ÿæˆæ¨¡æ¿')) {
                alert('æ²’æœ‰å…§å®¹å¯ä»¥è¤‡è£½');
                return;
            }

            navigator.clipboard.writeText(output).then(() => {
                alert('å·²è¤‡è£½');
                updateStatus('å·²è¤‡è£½');
            }).catch(() => {
                // å‚™ç”¨æ–¹æ³•
                const textarea = document.createElement('textarea');
                textarea.value = output;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('å·²è¤‡è£½');
                updateStatus('å·²è¤‡è£½');
            });
        }

        function clearOutput() {
            document.getElementById('output').textContent = 'é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¾†ç”Ÿæˆæ¨¡æ¿...';
            updateStatus('å·²æ¸…ç©º');
        }

        function saveAsFile() {
            const output = document.getElementById('output').textContent;
            if (!output.trim() || output.includes('é»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¾†ç”Ÿæˆæ¨¡æ¿')) {
                alert('æ²’æœ‰å…§å®¹å¯ä»¥å„²å­˜');
                return;
            }

            const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ä¸–ç•Œæ›¸Regexè§¸ç™¼Key.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            updateStatus('æª”æ¡ˆå·²å„²å­˜');
        }

        // å³æ™‚é è¦½åŠŸèƒ½
        let isPreviewMode = false;
        let isHighlightEnabled = true; // æ–°å¢ï¼šé«˜äº®é–‹é—œç‹€æ…‹
        let isUpdatingFromPreview = false;
        let previewHistory = []; // æ’¤éŠ·æ­·å²è¨˜éŒ„
        let historyIndex = -1; // ç•¶å‰æ­·å²ç´¢å¼•
        let lastSavedSelection = null; // å„²å­˜çš„é¸æ“‡ç¯„åœ

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('checkerInput');
            const previewContent = document.getElementById('previewContent');
            
            input.addEventListener('input', handleInputChange);
            previewContent.addEventListener('input', handlePreviewChange);
            previewContent.addEventListener('keydown', handlePreviewKeydown);
            previewContent.addEventListener('beforeinput', handlePreviewBeforeInput);
            
            // é˜²æ­¢é è¦½é¢æ¿ä¸­çš„æŸäº›é»˜èªè¡Œç‚º
            previewContent.addEventListener('paste', function(e) {
                e.preventDefault();
                const text = e.clipboardData.getData('text/plain');
                insertTextAtCursor(text);
                saveToHistory();
            });

            // ç›£è½ç„¦é»äº‹ä»¶ï¼Œä¿å­˜é¸æ“‡ç¯„åœ
            previewContent.addEventListener('blur', saveSelection);
            previewContent.addEventListener('focus', restoreSelection);
        });

        // è™•ç†é è¦½é¢æ¿æŒ‰éµäº‹ä»¶
        function handlePreviewKeydown(e) {
            if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
            } else if (e.ctrlKey && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                redo();
            }
        }

        // è™•ç†é è¦½é¢æ¿è¼¸å…¥å‰äº‹ä»¶
        function handlePreviewBeforeInput(e) {
            if (isPreviewMode && !isUpdatingFromPreview) {
                // åœ¨è¼¸å…¥å‰ä¿å­˜ç•¶å‰ç‹€æ…‹
                saveToHistory();
            }
        }

        // è™•ç†è¼¸å…¥è®ŠåŒ–
        function handleInputChange() {
            if (isPreviewMode && !isUpdatingFromPreview) {
                updatePreview();
            }
        }

        // è™•ç†é è¦½é¢æ¿å…§å®¹è®ŠåŒ–
        function handlePreviewChange(e) {
            if (isPreviewMode && !isUpdatingFromPreview) {
                isUpdatingFromPreview = true;
                
                const previewContent = document.getElementById('previewContent');
                const plainText = getPlainTextFromPreview(previewContent);
                
                document.getElementById('checkerInput').value = plainText;
                
                // å»¶é²é‡æ–°æ‡‰ç”¨é«˜äº®ï¼Œé¿å…å…‰æ¨™è·³å‹•
                setTimeout(() => {
                    updatePreviewWithoutCursorReset();
                    isUpdatingFromPreview = false;
                }, 10);
                
                updateCheckerStatus('é è¦½å…§å®¹å·²æ›´æ–°');
            }
        }

        // å¾é è¦½é¢æ¿æå–ç´”æ–‡æœ¬
        function getPlainTextFromPreview(element) {
            let text = '';
            for (let node of element.childNodes) {
                if (node.nodeType === Node.TEXT_NODE) {
                    text += node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    text += getPlainTextFromPreview(node);
                }
            }
            return text;
        }

        // åœ¨å…‰æ¨™ä½ç½®æ’å…¥æ–‡æœ¬
        function insertTextAtCursor(text) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                const textNode = document.createTextNode(text);
                range.insertNode(textNode);
                range.setStartAfter(textNode);
                range.setEndAfter(textNode);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        // ä¿å­˜é¸æ“‡ç¯„åœ
        function saveSelection() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                lastSavedSelection = {
                    start: getTextOffset(selection.getRangeAt(0).startContainer, selection.getRangeAt(0).startOffset),
                    end: getTextOffset(selection.getRangeAt(0).endContainer, selection.getRangeAt(0).endOffset)
                };
            }
        }

        // æ¢å¾©é¸æ“‡ç¯„åœ
        function restoreSelection() {
            if (lastSavedSelection && isPreviewMode) {
                setTimeout(() => {
                    setTextSelection(lastSavedSelection.start, lastSavedSelection.end);
                }, 10);
            }
        }

        // ç²å–æ–‡æœ¬åç§»é‡
        function getTextOffset(node, offset) {
            const previewContent = document.getElementById('previewContent');
            const walker = document.createTreeWalker(
                previewContent,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            let textOffset = 0;
            let currentNode;
            
            while (currentNode = walker.nextNode()) {
                if (currentNode === node) {
                    return textOffset + offset;
                }
                textOffset += currentNode.textContent.length;
            }
            
            return textOffset;
        }

        // è¨­ç½®æ–‡æœ¬é¸æ“‡
        function setTextSelection(start, end) {
            const previewContent = document.getElementById('previewContent');
            const walker = document.createTreeWalker(
                previewContent,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );
            
            const range = document.createRange();
            const selection = window.getSelection();
            let textOffset = 0;
            let startSet = false;
            let currentNode;
            
            while (currentNode = walker.nextNode()) {
                const nodeLength = currentNode.textContent.length;
                
                if (!startSet && textOffset + nodeLength >= start) {
                    range.setStart(currentNode, start - textOffset);
                    startSet = true;
                }
                
                if (startSet && textOffset + nodeLength >= end) {
                    range.setEnd(currentNode, end - textOffset);
                    break;
                }
                
                textOffset += nodeLength;
            }
            
            selection.removeAllRanges();
            selection.addRange(range);
        }

        // ä¿å­˜åˆ°æ­·å²è¨˜éŒ„
        function saveToHistory() {
            const previewContent = document.getElementById('previewContent');
            const currentText = getPlainTextFromPreview(previewContent);
            
            // ç§»é™¤ç•¶å‰ç´¢å¼•ä¹‹å¾Œçš„æ­·å²è¨˜éŒ„
            previewHistory = previewHistory.slice(0, historyIndex + 1);
            
            // æ·»åŠ æ–°çš„æ­·å²è¨˜éŒ„
            previewHistory.push(currentText);
            historyIndex = previewHistory.length - 1;
            
            // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡
            if (previewHistory.length > 25) {
                previewHistory.shift();
                historyIndex--;
            }
        }

        // æ’¤éŠ·æ“ä½œ
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                const previousText = previewHistory[historyIndex];
                
                isUpdatingFromPreview = true;
                document.getElementById('checkerInput').value = previousText;
                updatePreview();
                isUpdatingFromPreview = false;
                
                updateCheckerStatus('å·²æ’¤éŠ·æ“ä½œ');
            }
        }

        // é‡åšæ“ä½œ
        function redo() {
            if (historyIndex < previewHistory.length - 1) {
                historyIndex++;
                const nextText = previewHistory[historyIndex];
                
                isUpdatingFromPreview = true;
                document.getElementById('checkerInput').value = nextText;
                updatePreview();
                isUpdatingFromPreview = false;
                
                updateCheckerStatus('å·²é‡åšæ“ä½œ');
            }
        }

        // åˆ‡æ›é è¦½æ¨¡å¼
        function togglePreview() {
            isPreviewMode = !isPreviewMode;
            const toggleBtn = document.getElementById('previewToggle');
            const highlightBtn = document.getElementById('highlightToggle');
            const previewPanel = document.getElementById('previewPanel');
            const checkerOutput = document.getElementById('checkerOutput');
            
            if (isPreviewMode) {
                toggleBtn.classList.add('active');
                previewPanel.classList.add('active');
                checkerOutput.style.display = 'none';
                highlightBtn.style.display = 'inline-flex'; // é¡¯ç¤ºé«˜äº®æŒ‰éµ
                
                // æ›´æ–°é«˜äº®æŒ‰éµç‹€æ…‹
                if (isHighlightEnabled) {
                    highlightBtn.classList.add('active');
                } else {
                    highlightBtn.classList.remove('active');
                }
                
                // åˆå§‹åŒ–æ­·å²è¨˜éŒ„
                const input = document.getElementById('checkerInput').value;
                previewHistory = [input];
                historyIndex = 0;
                
                updatePreview();
                updateCheckerStatus('å³æ™‚é è¦½æ¨¡å¼å·²é–‹å•Ÿ - å¯ç›´æ¥ç·¨è¼¯ (Ctrl+Zæ’¤éŠ·)');
            } else {
                toggleBtn.classList.remove('active');
                previewPanel.classList.remove('active');
                checkerOutput.style.display = 'block';
                highlightBtn.style.display = 'none'; // éš±è—é«˜äº®æŒ‰éµ
                
                // æ¸…ç†æ­·å²è¨˜éŒ„
                previewHistory = [];
                historyIndex = -1;
                lastSavedSelection = null;
                
                updateCheckerStatus('å³æ™‚é è¦½æ¨¡å¼å·²é—œé–‰');
            }
        }

        // æ–°å¢ï¼šåˆ‡æ›é«˜äº®åŠŸèƒ½
        function toggleHighlight() {
            if (!isPreviewMode) return; // åªåœ¨é è¦½æ¨¡å¼ä¸‹æœ‰æ•ˆ
            
            isHighlightEnabled = !isHighlightEnabled;
            const highlightBtn = document.getElementById('highlightToggle');
            
            if (isHighlightEnabled) {
                highlightBtn.classList.add('active');
                updateCheckerStatus('æ‡‰ç”¨é«˜äº®å·²é–‹å•Ÿ');
            } else {
                highlightBtn.classList.remove('active');
                updateCheckerStatus('æ‡‰ç”¨é«˜äº®å·²é—œé–‰');
            }
            
            // ç«‹å³æ›´æ–°é è¦½å…§å®¹
            updatePreviewWithoutCursorReset();
        }

        // æ‡‰ç”¨é«˜äº®è¦å‰‡çš„å‡½æ•¸
        function applyHighlightRules(text) {
            if (!isHighlightEnabled) {
                return escapeHtml(text); // å¦‚æœé«˜äº®é—œé–‰ï¼Œåªé€²è¡ŒHTMLè½‰ç¾©
            }
            
            let highlightedText = escapeHtml(text);
            
            // 1. å…ˆé«˜äº®å†’è™Ÿï¼Œä½¿ç”¨å”¯ä¸€æ¨™è¨˜ä¿è­·
            highlightedText = highlightedText.replace(
                /([^<>]*?)(:)([^<>]*?)/g,
                '$1{{COLON_PLACEHOLDER}}$3'
            );

            // 2. é«˜äº®ç©ºç™½å­—ç¬¦
            highlightedText = highlightedText.replace(
                /( |\t)/g,
                '<span class="highlight-whitespace">$1</span>'
            );

            // 3. é‚„åŸå†’è™Ÿé«˜äº®
            highlightedText = highlightedText.replace(
                /{{COLON_PLACEHOLDER}}/g,
                '<span class="highlight-colon">:</span>'
            );

            // 4. é«˜äº® user
            highlightedText = highlightedText.replace(
                /(\buser\b)/ig,
                '<span class="highlight-user">$1</span>'
            );
            
            // 5. é«˜äº® char
            highlightedText = highlightedText.replace(
                /(\bchar\b)/ig,
                '<span class="highlight-char">$1</span>'
            );

            return highlightedText;
        }

        // æ›´æ–°å³æ™‚é è¦½ï¼ˆä¸é‡ç½®å…‰æ¨™ï¼‰
        function updatePreviewWithoutCursorReset() {
            const input = document.getElementById('checkerInput').value;
            const previewContent = document.getElementById('previewContent');
            
            if (!input.trim()) {
                previewContent.innerHTML = 'è«‹è¼¸å…¥æ–‡æœ¬ä»¥æŸ¥çœ‹å³æ™‚é è¦½...';
                return;
            }

            // ä¿å­˜ç•¶å‰é¸æ“‡
            saveSelection();

            // æ‡‰ç”¨é«˜äº®è¦å‰‡ï¼ˆæ ¹æ“šé–‹é—œç‹€æ…‹ï¼‰
            const highlightedText = applyHighlightRules(input);
            previewContent.innerHTML = highlightedText;

            // æ¢å¾©é¸æ“‡
            restoreSelection();
        }

        // æ›´æ–°å³æ™‚é è¦½
        function updatePreview() {
            const input = document.getElementById('checkerInput').value;
            const previewContent = document.getElementById('previewContent');
            
            if (!input.trim()) {
                previewContent.innerHTML = 'è«‹è¼¸å…¥æ–‡æœ¬ä»¥æŸ¥çœ‹å³æ™‚é è¦½...';
                return;
            }

            // æ‡‰ç”¨é«˜äº®è¦å‰‡ï¼ˆæ ¹æ“šé–‹é—œç‹€æ…‹ï¼‰
            const highlightedText = applyHighlightRules(input);
            previewContent.innerHTML = highlightedText;
        }

        // HTML è½‰ç¾©å‡½æ•¸
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ›´æ–°æª¢æŸ¥å™¨ç‹€æ…‹çš„å‡½æ•¸
        function updateCheckerStatus(text) {
            const statusElement = document.getElementById('checkerStatusText');
            if (statusElement) {
                statusElement.textContent = text;
            }
        }

        // æ–‡æœ¬æª¢æŸ¥å™¨åŠŸèƒ½
        function checkLength() {
            const input = document.getElementById('checkerInput').value;
            const output = document.getElementById('checkerOutput');
            
            if (!input.trim()) {
                alert('è«‹å…ˆè¼¸å…¥è¦æª¢æŸ¥çš„æ–‡æœ¬');
                return;
            }
            
            // å¦‚æœåœ¨é è¦½æ¨¡å¼ï¼Œå…ˆåˆ‡æ›å›æ­£å¸¸æ¨¡å¼
            if (isPreviewMode) {
                togglePreview();
            }
            
            const charCount = input.length;
            const wordCount = input.trim().split(/\s+/).length;
            const lineCount = input.split('\n').length;
            
            output.textContent = `æ–‡æœ¬é•·åº¦æª¢æŸ¥çµæœï¼š
            
å­—ç¬¦æ•¸ï¼š${charCount}
å–®è©æ•¸ï¼š${wordCount}
è¡Œæ•¸ï¼š${lineCount}
ä¸å«ç©ºæ ¼å­—ç¬¦æ•¸ï¼š${input.replace(/\s/g, '').length}`;
            
            updateCheckerStatus('é•·åº¦æª¢æŸ¥å®Œæˆ');
        }

        function checkSpaces() {
            const input = document.getElementById('checkerInput').value;
            const output = document.getElementById('checkerOutput');
            
            if (!input.trim()) {
                alert('è«‹å…ˆè¼¸å…¥è¦æª¢æŸ¥çš„æ–‡æœ¬');
                return;
            }
            
            // å¦‚æœåœ¨é è¦½æ¨¡å¼ï¼Œå…ˆåˆ‡æ›å›æ­£å¸¸æ¨¡å¼
            if (isPreviewMode) {
                togglePreview();
            }
            
            const spaces = input.match(/ /g) || [];
            const tabs = input.match(/\t/g) || [];
            const newlines = input.match(/\n/g) || [];
            const allWhitespace = input.match(/\s/g) || [];
            
            output.textContent = `ç©ºç™½å­—ç¬¦æª¢æŸ¥çµæœï¼š
            
ç©ºæ ¼æ•¸ï¼š${spaces.length}
Tabå­—ç¬¦æ•¸ï¼š${tabs.length}
æ›è¡Œç¬¦æ•¸ï¼š${newlines.length}
ç¸½ç©ºç™½å­—ç¬¦æ•¸ï¼š${allWhitespace.length}`;
            
            updateCheckerStatus('ç©ºç™½å­—ç¬¦æª¢æŸ¥å®Œæˆ');
        }

        function copyCheckerResult() {
            let contentToCopy;
            
            if (isPreviewMode) {
                // é è¦½æ¨¡å¼ä¸‹è¤‡è£½åŸå§‹æ–‡æœ¬
                contentToCopy = document.getElementById('checkerInput').value;
                if (!contentToCopy.trim()) {
                    alert('æ²’æœ‰å…§å®¹å¯ä»¥è¤‡è£½');
                    return;
                }
            } else {
                // æ­£å¸¸æ¨¡å¼ä¸‹è¤‡è£½æª¢æŸ¥çµæœ
                contentToCopy = document.getElementById('checkerOutput').textContent;
                if (!contentToCopy.trim() || contentToCopy.includes('è«‹è¼¸å…¥æ–‡æœ¬ä¸¦é¸æ“‡æª¢æŸ¥é …ç›®')) {
                    alert('æ²’æœ‰æª¢æŸ¥çµæœå¯ä»¥è¤‡è£½');
                    return;
                }
            }

            navigator.clipboard.writeText(contentToCopy).then(() => {
                alert('å·²è¤‡è£½');
                updateCheckerStatus('å·²è¤‡è£½');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = contentToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('å·²è¤‡è£½');
                updateCheckerStatus('å·²è¤‡è£½');
            });
        }

        function clearCheckerOutput() {
            if (isPreviewMode) {
                document.getElementById('checkerInput').value = '';
                document.getElementById('previewContent').innerHTML = 'è«‹è¼¸å…¥æ–‡æœ¬ä»¥æŸ¥çœ‹å³æ™‚é è¦½...';
                
                // é‡ç½®æ­·å²è¨˜éŒ„
                previewHistory = [''];
                historyIndex = 0;
                lastSavedSelection = null;
                
                updateCheckerStatus('å·²æ¸…ç©º');
            } else {
                document.getElementById('checkerOutput').textContent = 'è«‹è¼¸å…¥æ–‡æœ¬ä¸¦é¸æ“‡æª¢æŸ¥é …ç›®...';
                updateCheckerStatus('å·²æ¸…ç©º');
            }
        }

        function saveCheckerFile() {
            const output = document.getElementById('previewContent').textContent;
            if (!output.trim() || output.includes('è«‹å…ˆè¼¸å…¥æ–‡æœ¬')) {
                alert('æ²’æœ‰å…§å®¹å¯ä»¥å„²å­˜');
                return;
            }
            const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'æª¢æŸ¥å¾Œçš„æ–‡æœ¬.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            updateStatus('æª”æ¡ˆå·²å„²å­˜');
        }

             // Tokenè¨ˆæ•¸å™¨åŠŸèƒ½
                function calculateTokens() {
                const input = document.getElementById('tokenInput').value;
                const counter = document.getElementById('tokenCounter');

                if (!input) {
                    counter.textContent = `Token: 0`;
                    updateStatus('è«‹è¼¸å…¥æ–‡å­—');
                    return;
                }

                    // åŸºæ–¼å¯¦éš›å°æ¯”èª¿æ•´çš„ä¿‚æ•¸
                const chineseChars = (input.match(/[\u4e00-\u9fff]/g) || []).length;
                const englishWords = (input.match(/[a-zA-Z]+/g) || []).length;
                const englishChars = (input.match(/[a-zA-Z]+/g) || []).join('').length;
                const numbers = (input.match(/\d+/g) || []).length;
                const symbols = (input.match(/[^\w\s\u4e00-\u9fff]/g) || []).length;
                const spaces = (input.match(/\s+/g) || []).length;

                    
                    // èª¿æ•´å¾Œçš„ä¿‚æ•¸
                    const estimatedTokens = Math.round(
                        chineseChars * 1 +           // ä¸­æ–‡
                        englishChars * 0.235 +          // è‹±æ–‡
                        numbers * 0.5 +                // æ•¸å­—
                        symbols * 0.3 +                // ç¬¦è™Ÿ
                        spaces * 0.1                 // ç©ºæ ¼
                    );

    
                    counter.textContent = `Token: ${estimatedTokens}`;
                    updateStatus(`Tokenè¨ˆç®—å®Œæˆï¼š${estimatedTokens}`);
                }

        // åˆå§‹åŒ–ç‹€æ…‹
        updateGlobalStatus('é¦–é ');
        updateStatus('ç­‰å¾…æ“ä½œ');
        updateCheckerStatus('ç­‰å¾…æ“ä½œ');
        updateTextEditStatus('ç­‰å¾…æ“ä½œ')
        // {{char}} å’Œ {{user}} äº¤æ›åŠŸèƒ½
        function swapCharUser() {
            const input = document.getElementById('inputText');
            const output = document.getElementById('outputEditText');
            const text = input.value;

            if (!text.trim()) {
                updateTextEditStatus('è«‹å…ˆè¼¸å…¥æ–‡æœ¬ï¼');
                return;
            }

            // ä½¿ç”¨è‡¨æ™‚æ¨™è¨˜ä¾†é¿å…é‡è¤‡æ›¿æ›
            let result = text
                .replace(/\{\{char\}\}/g, '__TEMP_CHAR__')
                .replace(/\{\{user\}\}/g, '{{char}}')
                .replace(/__TEMP_CHAR__/g, '{{user}}');

            output.value = result;

            // çµ±è¨ˆæ›¿æ›æ•¸é‡
            const charCount = (text.match(/\{\{char\}\}/g) || []).length;
            const userCount = (text.match(/\{\{user\}\}/g) || []).length;
            const totalSwaps = charCount + userCount;

            if (totalSwaps > 0) {
                updateTextEditStatus(`æˆåŠŸäº¤æ› ${totalSwaps} å€‹æ¨™ç±¤ ({{char}}: ${charCount}å€‹, {{user}}: ${userCount}å€‹)`, 'success');
            } else {
                updateTextEditStatus('æ–‡æœ¬ä¸­æ²’æœ‰æ‰¾åˆ° {{char}} æˆ– {{user}} æ¨™ç±¤');
            }
        }

        // æ’å…¥ OOC æŒ‡ä»¤ (ä¸‹æ‹‰å¼é¸å–®)
        function insertOOC() {
            const select = document.getElementById('oocSelect');
            const input = document.getElementById('inputText');
            const output = document.getElementById('outputEditText');
            const selectedValue = select.value;
            
            if (!selectedValue) {
                updateTextEditStatus('è«‹é¸æ“‡ä¸€å€‹ OOC æŒ‡ä»¤é¸é …', 'error');
                return;
            }
            
            const oocCommands = {
                'option1': '[OOC: è«‹ç«‹åˆ»æš«åœåŠ‡æƒ…ï¼Œä¸¦é–‹å§‹æ¼”ç¹¹ä¸€æ®µæ–°åŠ‡æƒ…å’Œæƒ…å¢ƒ]',
                'option2': '[OOC: è«‹é–‹å§‹æ¼”ç¹¹ä»¥ä¸‹åŠ‡æƒ…: ',
                'option3': '{{char}}æœƒæœ‰ä»€éº¼åæ‡‰ï¼Ÿ{{char}}å…§å¿ƒæœƒç”¢ç”Ÿä»€éº¼æƒ³æ³•ï¼Ÿï¼Œ{{char}}åˆæœƒåšå‡ºä»€éº¼è¡Œå‹•ï¼Ÿ]',
                'option4': '{{user}}æœƒæœ‰ä»€éº¼åæ‡‰ï¼Ÿ{{user}}å…§å¿ƒæœƒç”¢ç”Ÿä»€éº¼æƒ³æ³•ï¼Ÿï¼Œ{{user}}åˆæœƒåšå‡ºä»€éº¼è¡Œå‹•ï¼Ÿ]',
                'option5': '[OOC: è«‹åƒè€ƒ{{char}}å’Œ{{user}}çš„è¨­å®šèˆ‡è£œå……è³‡è¨Šï¼Œä»¥ç”Ÿå‹•è©³ç´°çš„åŠ‡æƒ…æ–¹å¼æå¯«æ•´å€‹éç¨‹]'
            };
            
            const oocCommand = oocCommands[selectedValue];
            const inputText = input.value;
            const currentOutput = output.value;
            
            let result;
            if (currentOutput.trim()) {
                // å¦‚æœè¼¸å‡ºå€åŸŸå·²æœ‰å…§å®¹ï¼Œåœ¨é–‹é ­æ’å…¥
                result = oocCommand + '\n' + currentOutput;
            } else if (inputText.trim()) {
                // å¦‚æœè¼¸å‡ºå€åŸŸç‚ºç©ºä½†è¼¸å…¥å€åŸŸæœ‰å…§å®¹
                result = oocCommand + '\n' + inputText;
            } else {
                // å…©è€…éƒ½ç‚ºç©º
                result = oocCommand;
            }

            output.value = result;
            updateTextEditStatus(`å·²æ’å…¥ ${getOOCName(selectedValue)}`, 'success');
        }

        function getOOCName(option) {
            const names = {
                'option1': 'OOC æŒ‡ä»¤ 1 (æš«åœåŠ‡æƒ…)',
                'option2': 'OOC æŒ‡ä»¤ 2 (é–‹å§‹æ¼”ç¹¹)',  
                'option3': 'OOC æŒ‡ä»¤ 3 ({{char}}åæ‡‰)',
                'option4': 'OOC æŒ‡ä»¤ 4 ({{user}}åæ‡‰)',
                'option5': 'OOC æŒ‡ä»¤ 5 (ç”Ÿå‹•æè¿°)'
            };
            return names[option] || 'OOC æŒ‡ä»¤';
        }

        // æ’å…¥çµæŸç¬¦è™Ÿ ]
        function insertEndBracket() {
            const input = document.getElementById('inputText');
            const output = document.getElementById('outputEditText');
            const inputText = input.value;
            const currentOutput = output.value;

            let result;
            if (currentOutput.trim()) {
                // å¦‚æœè¼¸å‡ºå€åŸŸå·²æœ‰å…§å®¹ï¼Œåœ¨çµå°¾æ’å…¥
                result = currentOutput + ']';
            } else if (inputText.trim()) {
                // å¦‚æœè¼¸å‡ºå€åŸŸç‚ºç©ºä½†è¼¸å…¥å€åŸŸæœ‰å…§å®¹
                result = inputText + ']';
            } else {
                // å…©è€…éƒ½ç‚ºç©º
                result = ']';
            }

            output.value = result;
            updateTextEditStatus('å·²åœ¨æ–‡æœ¬çµå°¾æ’å…¥çµæŸç¬¦è™Ÿ ]');
        }

        // æ¸…ç©ºæ‰€æœ‰æ–‡æœ¬
        function clearAll() {
            document.getElementById('outputEditText').value = '';
            updateTextEditStatus('å·²æ¸…ç©º');
        }

        // è¤‡è£½çµæœåˆ°å‰ªè²¼æ¿
        function copyText() {
            const output = document.getElementById('outputEditText');
            
            if (!output.value.trim()) {
                updateTextEditStatus('æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹');
                return;
            }

            output.select();
            document.execCommand('copy');
            updateTextEditStatus('å·²è¤‡è£½');
        }

        // è¤‡è£½çµæœå›è¼¸å…¥å€
        function copyBackToInput() {
            const input = document.getElementById('inputText');
            const output = document.getElementById('outputEditText');
            
            if (!output.value.trim()) {
                updateTextEditStatus('æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹');
                return;
            }

            input.value = output.value;
            updateTextEditStatus('å·²åå‘è¤‡è£½å›è¼¸å…¥å€ï¼Œå¯ä»¥ç¹¼çºŒè™•ç†');
        }

        // è‡ªå‹•èª¿æ•´æ–‡æœ¬æ¡†é«˜åº¦
        function autoResize() {
            const textareas = document.querySelectorAll('.input-textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.max(150, this.scrollHeight) + 'px';
                });
            });
        }

        function saveTextEditFile() {
            const output = document.getElementById('outputEditText').value;
            if (!output.trim() || output.includes('è«‹å…ˆè¼¸å…¥æ–‡æœ¬')) {
                alert('æ²’æœ‰å…§å®¹å¯ä»¥å„²å­˜');
                return;
            }
            const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ç·¨è¼¯å¾Œçš„æŒ‡ä»¤æ–‡æœ¬.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            updateTextEditStatus('æª”æ¡ˆå·²å„²å­˜');
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            autoResize();
            updateTextEditStatus('ç­‰å¾…æ“ä½œ');
        });
    </script>
</body>
</html>

